---
title: "Problem sheet: clustering using k-means"
output: html_notebook
---

```{r}
rm(list=ls())
library(tidyverse)
library(reshape2)
```

1. Load the iris data. Write a k-means algorithm from scratch and use it to cluster the points assuming 3 clusters. Use the Euclidean distance metric.
```{r}
x <- iris %>% 
  select(-Species)

# choose number of clusters, k
f_choose_random_centroids <- function(x, k=3) {
  idxs <- 1:nrow(x)
  idxs <- sample(idxs, k)
  return(x[idxs, ])
}

# assign points to nearest centroid
f_eucl_dist <- function(x1, x2) {return(sqrt(sum((x1 - x2)^2)))}
f_eucl_dist_all <- function(x, centroid) {
  return(map_dbl(seq(1, nrow(x), 1), ~f_eucl_dist(centroid, x[., ])))
}
f_eucl_dist_centroids <- function(x, centroids) {
  m_dist <- matrix(nrow = nrow(x), ncol = nrow(centroids))
  for(i in 1:nrow(centroids))
    m_dist[, i] <- f_eucl_dist_all(x, centroids[i, ])
  return(m_dist)
}
f_cluster <- function(x, centroids) {
  m_dist <- f_eucl_dist_centroids(x, centroids)
  cluster_id <- vector(length = nrow(m_dist))
  for(i in seq_along(cluster_id))
    cluster_id[i] <- which.min(m_dist[i, ])
  return(cluster_id)
}

# recalculate centroids based on clusters
f_recalculate_centroids <- function(cluster_ids, x) {
  df <- x %>% 
    as.data.frame() %>% 
    mutate(cluster=cluster_ids)
  mu <- df %>% 
    group_by(cluster) %>% 
    summarise_all(.funs=mean) %>% 
    select(-cluster)
  return(mu)  
}

# here I just use 50 iterations as a stopping criteria
# better to look at cluster identities and only stop
# once these stop changing
f_kmeans <- function(x, k, niter=50) {
  for(i in 1:niter) {
    if(i == 1)
      centroids <- f_choose_random_centroids(x, k)
    else
      centroids <- f_recalculate_centroids(cluster_ids, x)
    cluster_ids <- f_cluster(x, centroids)
  }
  return(cluster_ids)
}

clusters <- f_kmeans(x, 3)
```

2. How do your clusters correspond to species?
```{r}
df <- iris %>% 
  as.data.frame() %>% 
  mutate(cluster=clusters)
table(df$Species, df$cluster)
```
Does a pretty good job of separating out the three species. Setosa is more different from the other two classes.

3. What happens if you choose only two clusters?
```{r}
clusters <- f_kmeans(x, 2)
df <- iris %>% 
  as.data.frame() %>% 
  mutate(cluster=clusters)
table(df$Species, df$cluster)
```
Splits data in setosa and others. Makes sense, since assuming 3 clusters mixtured up the versicolor and virginica datasets
